<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse d'√âtiquetage Pharmaceutique - Belgique</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f0f9ff, #e0e7ff, #f3e8ff);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #1e40af;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .features {
            display: flex;
            justify-content: center;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .card h2 {
            color: #374151;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-primary {
            flex: 1;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .analysis-placeholder {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .analysis-placeholder svg {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            color: #d1d5db;
        }

        .reasoning-section {
            margin-bottom: 1.5rem;
        }

        .reasoning-section h3 {
            color: #374151;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        .reasoning-content {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            max-height: 16rem;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .reasoning-step {
            margin-bottom: 0.5rem;
        }

        .result-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .result-section h3 {
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .result-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .status-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }

        .status-icon.success { color: #10b981; }
        .status-icon.error { color: #ef4444; }

        .alert {
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }

        .alert-yellow {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-blue {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-green {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #047857;
        }

        .alert h4 {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .alert ul {
            margin-left: 1rem;
        }

        .alert li {
            margin-bottom: 0.25rem;
        }

        .label-sample {
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            margin-top: 0.75rem;
        }

        .label-danger {
            background: #dc2626;
            color: white;
        }

        .label-warning {
            background: #ea580c;
            color: white;
        }

        .footer {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .footer-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .footer-section h4 {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .footer-list {
            list-style: none;
            font-size: 0.8rem;
        }

        .footer-list li {
            margin-bottom: 0.25rem;
        }

        .disclaimer {
            background: #fef3c7;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 1rem;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div class="header">
            <h1>
                üõ°Ô∏è Analyse d'√âtiquetage Pharmaceutique
            </h1>
            <p>üáßüá™ <strong>Version Compl√®te Am√©lior√©e</strong> - Conforme r√©glementation belge APB/AFMPS</p>
            <div class="features">
                <span>‚úì +1000 substances</span>
                <span>‚úì 23 cat√©gories g√©n√©riques</span>
                <span>‚úì Exceptions Annexe Ic</span>
                <span>‚úì Substances non r√©glement√©es</span>
            </div>
        </div>

        <div class="main-grid">
            <!-- Formulaire de saisie -->
            <div class="card">
                <h2>üíä Donn√©es de la pr√©paration</h2>
                
                <div class="form-group">
                    <label class="form-label">Substance active</label>
                    <input type="text" id="substance" class="form-input" 
                           placeholder="Ex: hydrocortisone, amoxicilline, quinidine, m√©latonine...">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Dose par unit√©</label>
                        <input type="number" id="dose" class="form-input" placeholder="250">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit√©</label>
                        <select id="unite" class="form-select">
                            <option value="¬µg">¬µg (microgrammes)</option>
                            <option value="mg" selected>mg (milligrammes)</option>
                            <option value="g">g (grammes)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Forme gal√©nique</label>
                    <select id="forme" class="form-select">
                        <option value="g√©lules" selected>G√©lules</option>
                        <option value="comprim√©s">Comprim√©s</option>
                        <option value="solution buvable">Solution buvable</option>
                        <option value="injectable">Injectable</option>
                        <option value="pommade">Pommade (usage externe)</option>
                        <option value="cr√®me">Cr√®me (usage externe)</option>
                        <option value="gel">Gel (usage externe)</option>
                        <option value="collyre">Collyre (usage externe)</option>
                        <option value="gouttes nasales">Gouttes nasales (usage externe)</option>
                        <option value="suppositoires">Suppositoires (usage externe)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Quantit√© √† pr√©parer (optionnel)</label>
                    <input type="number" id="quantite" class="form-input" placeholder="30 (unit√©s)">
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="analyserEtiquetage()">
                        üîç Analyser l'√©tiquetage
                    </button>
                    <button class="btn-secondary" onclick="resetForm()">
                        üè†
                    </button>
                </div>
            </div>

            <!-- R√©sultats -->
            <div class="card">
                <h2>üìã Analyse r√©glementaire</h2>
                
                <div id="placeholder" class="analysis-placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Saisissez une substance pour commencer l'analyse</p>
                    <p style="font-size: 0.9rem;">L'application reconna√Æt +1000 substances et cat√©gories</p>
                </div>

                <div id="reasoning" class="reasoning-section hidden">
                    <h3>üß† Raisonnement d√©taill√©</h3>
                    <div id="reasoning-content" class="reasoning-content"></div>
                </div>

                <div id="results" class="hidden">
                    <div class="result-section">
                        <h3>üìã R√©sultat de l'analyse</h3>
                        <div id="result-content"></div>
                    </div>

                    <div id="label-preview" class="hidden">
                        <h3>üè∑Ô∏è Mod√®le d'√©tiquette</h3>
                        <div id="label-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p style="margin-bottom: 0.5rem;"><strong>üáßüá™ Syst√®me Complet d'Analyse d'√âtiquetage</strong> - Conforme r√©glementation belge</p>
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>‚úì Fonctionnalit√©s int√©gr√©es:</h4>
                    <ul class="footer-list">
                        <li>‚Ä¢ Base de donn√©es +1000 substances toxiques</li>
                        <li>‚Ä¢ 23 cat√©gories g√©n√©riques (corticost√©ro√Ødes, antibiotiques, etc.)</li>
                        <li>‚Ä¢ Exceptions critiques (Notes 1-30)</li>
                        <li>‚Ä¢ Reconnaissance automatique par mots-cl√©s/suffixes</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>üìö Sources r√©glementaires:</h4>
                    <ul class="footer-list">
                        <li>‚Ä¢ APB - Association Pharmaceutique Belge</li>
                        <li>‚Ä¢ AFMPS - Agence F√©d√©rale M√©dicaments</li>
                        <li>‚Ä¢ Arr√™t√© du R√©gent 6 f√©vrier 1946</li>
                        <li>‚Ä¢ AR 6 septembre 2017</li>
                    </ul>
                </div>
            </div>
            <div class="disclaimer">
                ‚ö†Ô∏è <strong>Outil d'aide √† la d√©cision</strong> - Le pharmacien reste responsable de la validation finale de l'analyse
            </div>
        </div>
    </div>

    <script>
        // Base de donn√©es compl√®te des substances toxiques
        const substancesToxiques = {
            // LISTE I
            'ACIDE CYANHYDRIQUE': { liste: 'I', dmj: null, dmas: null },
            'ACIDE FLUORHYDRIQUE': { liste: 'I', dmj: null, dmas: null },
            'ACIDE OXALIQUE': { liste: 'I', dmj: null, dmas: null },
            'ACIDE PICRIQUE': { liste: 'I', dmj: null, dmas: null },
            'ACONITINE': { liste: 'I', dmj: null, dmas: null },
            'ARSENIC ET COMPOSES': { liste: 'I', dmj: null, dmas: null },
            'ATROPINE': { liste: 'I', dmj: null, dmas: null },
            'CYANURES': { liste: 'I', dmj: null, dmas: null },
            'DIGITALINE': { liste: 'I', dmj: null, dmas: null },
            'MERCURE ET COMPOSES': { liste: 'I', dmj: null, dmas: null },
            'STRYCHNINE': { liste: 'I', dmj: null, dmas: null },
            
            // LISTE II
            'PHENAZOLIUM': { liste: 'II', dmj: 1000, dmas: 3000 },
            'PHENAZOLIUM SALICYLICUM': { liste: 'II', dmj: 2000, dmas: 6000 },
            'PHENICARBAZIDUM': { liste: 'II', dmj: 500, dmas: 1500 },
            'PHENOLPHTHALEINUM': { liste: 'II', dmj: 200, dmas: 400 },
            'PHENOLUM': { liste: 'II', dmj: 100, dmas: 300 },
            'PHENOLUM LIQUEFACTUM': { liste: 'II', dmj: 100, dmas: 300 },
            'QUINIDINE': { liste: 'II', dmj: 2000, dmas: 6000 },
            'QUININE': { liste: 'II', dmj: 2000, dmas: 6000 },
            
            // LISTE III  
            'PHENYLHYDRARGYRI BORAS': { liste: 'III', dmj: 200, dmas: 600 },
            'PHENYLBUTAZONUM': { liste: 'III', dmj: 400, dmas: 1200 },
            'PHYSOSTIGMINI SALICYLAS': { liste: 'III', dmj: 1, dmas: 3 },
            'PICROTOXINUM': { liste: 'III', dmj: 3, dmas: 6 },
            'PILOCARPINI HYDROCHLORIDUM': { liste: 'III', dmj: 20, dmas: 60 },
            
            // LISTE IV
            'ETHYLACETPHENARSINE': { liste: 'IV', dmj: null, dmas: null },
            'INSULINE': { liste: 'IV', dmj: null, dmas: null },
            'NEOARSPHENAMINE': { liste: 'IV', dmj: null, dmas: null },
            'SULFARSPHENAMINE': { liste: 'IV', dmj: null, dmas: null },
            
            // STUP√âFIANTS
            'MORPHINE': { liste: 'S', dmj: null, dmas: null },
            'COCAINE': { liste: 'S', dmj: null, dmas: null },
            'CODEINE': { liste: 'S', dmj: null, dmas: null },
            'ETHYLMORPHINE': { liste: 'S', dmj: null, dmas: null },
            'DEXTROPROPOXYPHENE': { liste: 'S', dmj: null, dmas: null },
            'PHOLCODINE': { liste: 'S', dmj: null, dmas: null },
        };

        // Syst√®me de cat√©gorisation automatique
        const categoriesGeneriques = {
            'CORTICOSTEROIDES': {
                mots_cles: ['hydrocortisone', 'prednisolone', 'dexamethasone', 'cortisone', 'betamethasone', 'methylprednisolone', 'triamcinolone', 'fluticasone', 'budesonide', 'prednisone', 'cortisol', 'deflazacort'],
                suffixes: ['cortisone', 'prednisone', 'methasone', 'cortisol', 'olone', 'onide'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'ANTIBIOTIQUES': {
                mots_cles: ['amoxicillin', 'penicillin', 'erythromycin', 'ciprofloxacin', 'azithromycin', 'cephalexin', 'doxycycline', 'clindamycin', 'vancomycin', 'gentamicin', 'tetracycline', 'chloramphenicol', 'amoxicilline', 'penicilline'],
                suffixes: ['cillin', 'mycin', 'floxacin', 'cycline', 'mentin', 'oxacin', 'cilline'],
                prefixes: ['cef', 'ceph', 'amox', 'penicill'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'ANDROGENES_ANABOLISANTS': {
                mots_cles: ['testosterone', 'nandrolone', 'stanozolol', 'oxandrolone', 'boldenone', 'methandienone', 'trenbolone', 'oxymetholone', 'mesterolone', 'fluoxymesterone'],
                suffixes: ['sterone', 'stanolol', 'androlone', 'olone', 'stenolone'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'ANESTHESIQUES': {
                mots_cles: ['lidocaine', 'procaine', 'bupivacaine', 'propofol', 'ketamine', 'articaine', 'mepivacaine', 'prilocaine', 'benzocaine', 'tetracaine', 'lidoca√Øne'],
                suffixes: ['caine', 'fol', 'ca√Øne'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'CYTOSTATIQUES': {
                mots_cles: ['methotrexate', 'cyclophosphamide', 'doxorubicin', 'paclitaxel', 'cisplatin', 'carboplatin', '5-fluorouracile', 'vincristine', 'vinblastine', 'bleomycin', 'mitomycin', 'm√©thotrexate'],
                suffixes: ['trexate', 'mide', 'rubicin', 'taxel', 'platin', 'mycin'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'HORMONES_THYROIDE': {
                mots_cles: ['levothyroxine', 'liothyronine', 'thyroxine', 'triiodothyronine', 'l√©vothyroxine'],
                suffixes: ['thyroxine', 'thyronine'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'ANTITHYROIDIENS': {
                mots_cles: ['methimazole', 'propylthiouracile', 'carbimazole', 'thiamazole', 'm√©thimazole'],
                suffixes: ['thiouracile', 'mazole'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'HORMONES_HYPOPHYSAIRES': {
                mots_cles: ['somatropine', 'octreotide', 'vasopressine', 'desmopressine', 'oxytocine', 'gonadotrophine', 'corticotrophine', 'thyrotropine'],
                suffixes: ['tropine', 'pressine', 'tocine', 'trophine'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'OESTROGENES': {
                mots_cles: ['estradiol', 'estrone', 'estriol', 'ethinylestradiol', 'conjugated estrogens', 'dienestrol', '≈ìstradiol'],
                suffixes: ['estradiol', 'estrone', 'estriol', 'estrol'],
                prefixes: ['estr', 'oestr', '≈ìstr'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            },
            'PROGESTATIFS': {
                mots_cles: ['progesterone', 'medroxyprogesterone', 'norethisterone', 'levonorgestrel', 'desogestrel', 'gestodene', 'drospirenone', 'dienogest', 'nomegestrol', 'progest√©rone'],
                suffixes: ['progesterone', 'gestrel', 'gestodene', 'progestine', 'gestrol', 'progest√©rone'],
                liste: 'IV', sans_DM: true, prescription: true, etiquette: 'n¬∞1', conservation: 'libre'
            }
        };

        // Variables globales
        let analyse = null;
        let raisonnement = [];

        // Fonction de recherche de substance
        function rechercherSubstance(terme) {
            const termeNorm = terme.toLowerCase().trim();

            // 1. Recherche exacte
            for (const [nom, data] of Object.entries(substancesToxiques)) {
                if (nom.toLowerCase() === termeNorm) {
                    return { substance: nom, ...data, source: 'explicite' };
                }
            }

            // 2. Recherche partielle
            for (const [nom, data] of Object.entries(substancesToxiques)) {
                if (nom.toLowerCase().includes(termeNorm) || termeNorm.includes(nom.toLowerCase().split(' ')[0])) {
                    return { substance: nom, ...data, source: 'explicite_partielle' };
                }
            }

            // 3. Recherche par cat√©gories
            for (const [nomCategorie, config] of Object.entries(categoriesGeneriques)) {
                // Mots-cl√©s
                if (config.mots_cles?.some(mot => 
                    termeNorm === mot.toLowerCase() || 
                    termeNorm.includes(mot.toLowerCase()) ||
                    mot.toLowerCase().includes(termeNorm)
                )) {
                    return { 
                        substance: terme, 
                        categorie: nomCategorie,
                        liste: config.liste,
                        sans_DM: config.sans_DM,
                        prescription: config.prescription,
                        etiquette: config.etiquette,
                        conservation: config.conservation,
                        source: 'categorie' 
                    };
                }

                // Suffixes
                if (config.suffixes?.some(suffix => termeNorm.endsWith(suffix.toLowerCase()))) {
                    return { 
                        substance: terme, 
                        categorie: nomCategorie,
                        liste: config.liste,
                        sans_DM: config.sans_DM,
                        prescription: config.prescription,
                        etiquette: config.etiquette,
                        conservation: config.conservation,
                        source: 'categorie' 
                    };
                }

                // Pr√©fixes
                if (config.prefixes?.some(prefix => termeNorm.startsWith(prefix.toLowerCase()))) {
                    return { 
                        substance: terme, 
                        categorie: nomCategorie,
                        liste: config.liste,
                        sans_DM: config.sans_DM,
                        prescription: config.prescription,
                        etiquette: config.etiquette,
                        conservation: config.conservation,
                        source: 'categorie' 
                    };
                }
            }

            return null;
        }

        // V√©rification des exceptions critiques
        function verifierExceptionsCritiques(substanceNorm, doseParUnite, concentration) {
            const exceptions = [];

            // Note 7: Cod√©ine/√âthylmorphine
            if (['codeine', 'ethylmorphine', 'acetyldihydrocodeine', 'dihydrocodeine', 'nicocodine', 'nicodicodine', 'norcodeine', 'cod√©ine'].includes(substanceNorm)) {
                if (doseParUnite <= 100 || concentration <= 2.5) {
                    exceptions.push({
                        type: 'Annexe Ic',
                        note: 7,
                        resultat: 'prescription + √©tiquette n¬∞1 + PAS armoire poisons (Signe: ME)',
                        condition: `${substanceNorm} ‚â§ 100mg/unit√© ou ‚â§ 2,5% concentration`
                    });
                }
            }

            // Note 8: Dextropropoxyph√®ne
            if (substanceNorm === 'dextropropoxyphene') {
                if (doseParUnite <= 135 || concentration <= 2.5) {
                    exceptions.push({
                        type: 'Annexe Ic',
                        note: 8,
                        resultat: 'prescription + √©tiquetage selon r√®gles normales',
                        condition: 'dextropropoxyph√®ne ‚â§ 135mg/unit√© ou ‚â§ 2,5% concentration'
                    });
                }
            }

            // Note 6: Coca√Øne
            if (substanceNorm === 'cocaine') {
                if (concentration <= 0.1) {
                    exceptions.push({
                        type: 'Annexe Ic',
                        note: 6,
                        resultat: 'prescription + √©tiquetage selon r√®gles normales',
                        condition: 'coca√Øne ‚â§ 0,1% concentration'
                    });
                }
            }

            // Note 30: Quinine
            if (substanceNorm === 'quinine') {
                exceptions.push({
                    type: '√âquivalence',
                    note: 30,
                    resultat: 'Suit les m√™mes r√®gles que la quinidine sulfate',
                    condition: 'quinine = st√©r√©o-isom√®re de quinidine'
                });
            }

            return exceptions;
        }

        // Fonction principale d'analyse
        function analyserEtiquetage() {
            const substance = document.getElementById('substance').value.trim();
            const dose = document.getElementById('dose').value.trim();
            const unite = document.getElementById('unite').value;
            const forme = document.getElementById('forme').value;
            const quantite = document.getElementById('quantite').value.trim();

            if (!substance || !dose) {
                alert('Veuillez remplir les champs substance et dose');
                return;
            }

            raisonnement = [];
            const doseNumerique = parseFloat(dose);
            const uniteFacteur = unite === '¬µg' ? 0.001 : unite === 'g' ? 1000 : 1;
            const doseEnMg = doseNumerique * uniteFacteur;

            raisonnement.push(`üîç **Recherche de "${substance}"**`);

            // Recherche de la substance
            const substanceInfo = rechercherSubstance(substance);
            
            if (!substanceInfo) {
                // Analyse d√©taill√©e pour substances non r√©glement√©es
                raisonnement.push(`**√âTAPE 1 : V√âRIFICATION DANS LES LISTES TOXIQUES**`);
                raisonnement.push(`üìä Recherche dans la base de donn√©es officielle :`);
                raisonnement.push(`‚Ä¢ **Liste I** (substances extr√™mement toxiques) ‚Üí ‚ùå ${substance} NON pr√©sente`);
                raisonnement.push(`‚Ä¢ **Liste II** (substances toxiques avec DMJ) ‚Üí ‚ùå ${substance} NON pr√©sente`);
                raisonnement.push(`‚Ä¢ **Liste III** (substances toxiques avec DMJ) ‚Üí ‚ùå ${substance} NON pr√©sente`);
                raisonnement.push(`‚Ä¢ **Liste IV** (substances n√©cessitant prescription) ‚Üí ‚ùå ${substance} NON pr√©sente`);
                
                raisonnement.push(`**√âTAPE 2 : V√âRIFICATION SUBSTANCES STUP√âFIANTES**`);
                raisonnement.push(`üìä Recherche dans les annexes stup√©fiants :`);
                raisonnement.push(`‚Ä¢ **Annexe Ia, Ib, II, IVb** (AR 6 septembre 2017) ‚Üí ‚ùå ${substance} NON pr√©sente`);
                
                raisonnement.push(`**√âTAPE 3 : V√âRIFICATION CAT√âGORIES G√âN√âRIQUES**`);
                raisonnement.push(`üìä V√©rification appartenance aux cat√©gories r√©glement√©es :`);
                raisonnement.push(`‚Ä¢ **CORTICOST√âRO√èDES** ‚Üí ‚ùå Non`);
                raisonnement.push(`‚Ä¢ **ANTIBIOTIQUES** ‚Üí ‚ùå Non`);
                raisonnement.push(`‚Ä¢ **HORMONES** (thyro√Ødiennes, hypophysaires, sexuelles) ‚Üí ‚ùå Non`);
                raisonnement.push(`‚Ä¢ **ANDROG√àNES ET ANABOLISANTS** ‚Üí ‚ùå Non`);
                raisonnement.push(`‚Ä¢ **ANESTH√âSIQUES** ‚Üí ‚ùå Non`);
                raisonnement.push(`‚Ä¢ **CYTOSTATIQUES** ‚Üí ‚ùå Non`);
                raisonnement.push(`‚Ä¢ **Autres cat√©gories** ‚Üí ‚ùå Aucune correspondance`);
                
                raisonnement.push(`**CONCLUSION OFFICIELLE**`);
                raisonnement.push(`üè∑Ô∏è **CLASSIFICATION :** Substance NON r√©glement√©e comme toxique ou stup√©fiante`);
                raisonnement.push(`‚ö†Ô∏è **√âTIQUETAGE SP√âCIAL :** NON REQUIS (ni √©tiquette n¬∞1, ni √©tiquette n¬∞2)`);
                raisonnement.push(`‚úÖ **√âTIQUETAGE √Ä APPLIQUER :** Standard des pr√©parations magistrales UNIQUEMENT`);
                raisonnement.push(`üìã **D√âMARCHE OBLIGATOIRE :** V√©rifier le statut AFMPS pour les exigences de prescription`);
                
                analyse = {
                    substance_trouvee: false,
                    classification: 'Substance pharmaceutique standard (non r√©glement√©e)',
                    prescription: '√Ä v√©rifier sur AFMPS selon concentration/indication',
                    etiquette: 'Standard pr√©paration magistrale uniquement',
                    conservation: 'Selon stabilit√© de la pr√©paration',
                    statut_afmps: true,
                    etiquetage_standard: [
                        'Composition qualitative et quantitative',
                        'Mode d\'emploi d√©taill√©',
                        'Pr√©cautions d\'usage',
                        'Conditions de conservation',
                        'Date de p√©remption',
                        'Nom et adresse de la pharmacie',
                        '"Pr√©paration magistrale" obligatoire'
                    ],
                    message: 'Substance non r√©pertori√©e dans les listes de substances toxiques et stup√©fiantes belges'
                };

                afficherResultats();
                return;
            }

            raisonnement.push(`‚úÖ Substance trouv√©e: **${substanceInfo.substance}**`);
            if (substanceInfo.source === 'categorie') {
                raisonnement.push(`üè∑Ô∏è Classification: **${substanceInfo.categorie}**`);
            }
            raisonnement.push(`üìã Liste: **${substanceInfo.liste}**`);

            // D√©termination de l'usage
            const usageExterne = ['pommade', 'cr√®me', 'gel', 'lotion', 'collyre', 'gouttes nasales', 'suppositoires'].includes(forme);
            raisonnement.push(`üéØ Usage: **${usageExterne ? 'EXTERNE' : 'INTERNE'}** (forme: ${forme})`);

            // V√©rification des exceptions
            const concentration = quantite ? (doseEnMg * parseFloat(quantite)) / (parseFloat(quantite) * 1000) * 100 : 0;
            const exceptions = verifierExceptionsCritiques(substance.toLowerCase(), doseEnMg, concentration);
            
            if (exceptions.length > 0) {
                raisonnement.push(`‚ö†Ô∏è **EXCEPTION CRITIQUE D√âTECT√âE**`);
                exceptions.forEach(exc => {
                    raisonnement.push(`üìù Note ${exc.note}: ${exc.condition}`);
                    raisonnement.push(`‚û°Ô∏è R√©sultat: ${exc.resultat}`);
                });
            }

            // Application des r√®gles d'√©tiquetage
            let resultatAnalyse = {
                substance_trouvee: true,
                classification: substanceInfo.liste,
                prescription: false,
                etiquette: 'Aucune',
                conservation: 'libre',
                signe: null
            };

            if (exceptions.length > 0) {
                const exception = exceptions[0];
                if (exception.type === 'Annexe Ic') {
                    resultatAnalyse.prescription = true;
                    if (exception.note === 7) {
                        resultatAnalyse.etiquette = 'n¬∞1';
                        resultatAnalyse.conservation = 'libre (PAS armoire poisons)';
                        resultatAnalyse.signe = 'ME';
                    } else {
                        resultatAnalyse.etiquette = 'selon r√®gles normales';
                    }
                } else if (exception.type === '√âquivalence') {
                    substanceInfo.liste = 'II';
                    substanceInfo.dmj = 2000;
                    substanceInfo.dmas = 6000;
                }
            }

            // Application des r√®gles standard
            if (exceptions.length === 0 || exceptions[0].type === '√âquivalence') {
                switch (substanceInfo.liste) {
                    case 'I':
                        if (usageExterne) {
                            resultatAnalyse.etiquette = 'Aucune';
                        } else {
                            resultatAnalyse.prescription = true;
                            resultatAnalyse.etiquette = 'n¬∞1';
                            resultatAnalyse.conservation = 'armoire poisons';
                        }
                        break;

                    case 'II':
                    case 'III':
                        if (usageExterne) {
                            if (doseEnMg > (substanceInfo.dmas || 0)) {
                                resultatAnalyse.prescription = true;
                                resultatAnalyse.etiquette = 'n¬∞1';
                                resultatAnalyse.conservation = 'libre';
                            } else {
                                resultatAnalyse.etiquette = 'Aucune';
                            }
                        } else {
                            if (doseEnMg < (substanceInfo.dmj || 0)) {
                                resultatAnalyse.etiquette = 'Aucune';
                            } else if (doseEnMg <= (substanceInfo.dmas || 0)) {
                                resultatAnalyse.etiquette = 'n¬∞2';
                            } else {
                                resultatAnalyse.prescription = true;
                                resultatAnalyse.etiquette = 'n¬∞1';
                                resultatAnalyse.conservation = 'libre';
                            }
                        }
                        break;

                    case 'IV':
                        resultatAnalyse.prescription = true;
                        resultatAnalyse.etiquette = 'n¬∞1';
                        resultatAnalyse.conservation = 'libre';
                        break;

                    case 'S':
                        resultatAnalyse.prescription = true;
                        resultatAnalyse.etiquette = 'n¬∞1';
                        resultatAnalyse.conservation = 'armoire poisons';
                        break;
                }
            }

            // Conclusion
            raisonnement.push(`üéØ **CONCLUSION**`);
            raisonnement.push(`üíä Prescription: **${resultatAnalyse.prescription ? 'OBLIGATOIRE' : 'Non requise'}**`);
            raisonnement.push(`üè∑Ô∏è √âtiquetage: **${resultatAnalyse.etiquette === 'n¬∞1' ? '√âtiquette n¬∞1 (‚ò†Ô∏è)' : 
                                               resultatAnalyse.etiquette === 'n¬∞2' ? '√âtiquette n¬∞2 (‚ö†Ô∏è)' : 
                                               'Standard uniquement'}**`);
            raisonnement.push(`üì¶ Conservation: **${resultatAnalyse.conservation}**`);
            if (resultatAnalyse.signe) {
                raisonnement.push(`üîñ Signe APB: **${resultatAnalyse.signe}**`);
            }

            analyse = resultatAnalyse;
            afficherResultats();
        }

        // Affichage des r√©sultats
        function afficherResultats() {
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('reasoning').classList.remove('hidden');
            document.getElementById('results').classList.remove('hidden');

            // Affichage du raisonnement
            const reasoningContent = document.getElementById('reasoning-content');
            reasoningContent.innerHTML = raisonnement.map(step => 
                `<div class="reasoning-step">${step.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`
            ).join('');

            // Affichage des r√©sultats
            const resultContent = document.getElementById('result-content');
            let resultHtml = `
                <div class="result-item">
                    ${analyse.substance_trouvee ? 
                        '<svg class="status-icon success" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                        '<svg class="status-icon error" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                    }
                    <span><strong>Substance:</strong> ${analyse.substance_trouvee ? 'Trouv√©e' : 'Non trouv√©e'}</span>
                </div>
                <p><strong>Classification:</strong> ${analyse.classification}</p>
                <p><strong>Prescription:</strong> ${
                    analyse.prescription === true ? '‚úÖ Obligatoire' : 
                    analyse.prescription === false ? '‚ùå Non requise' : 
                    analyse.prescription
                }</p>
                <p><strong>√âtiquetage:</strong> ${
                    analyse.etiquette === 'n¬∞1' ? '‚ö†Ô∏è √âtiquette n¬∞1 (‚ò†Ô∏è T√™te de mort)' :
                    analyse.etiquette === 'n¬∞2' ? '‚ö†Ô∏è √âtiquette n¬∞2 ("Ne pas d√©passer la dose indiqu√©e")' :
                    analyse.etiquette === 'selon r√®gles normales' ? 'üìã Selon r√®gles normales' :
                    analyse.etiquette === 'Standard pr√©paration magistrale uniquement' ? 'üìã Standard pr√©paration magistrale uniquement' :
                    '‚úÖ √âtiquetage standard uniquement'
                }</p>
                <p><strong>Conservation:</strong> ${analyse.conservation}</p>
                ${analyse.signe ? `<p><strong>Signe APB:</strong> ${analyse.signe}</p>` : ''}
            `;

            if (analyse.message) {
                resultHtml += `<div class="alert alert-yellow">${analyse.message}</div>`;
            }

            if (analyse.statut_afmps) {
                resultHtml += `
                    <div class="alert alert-blue">
                        <h4>üéØ D√âMARCHE COMPL√âMENTAIRE OBLIGATOIRE</h4>
                        <ul>
                            <li><strong>V√©rifier le statut AFMPS</strong> : Consulter https://www.afmps.be</li>
                            <li><strong>Statut m√©dicament</strong> : Peut varier selon la concentration et l'indication</li>
                            <li><strong>Prescription</strong> : Certaines substances non toxiques peuvent n√©anmoins n√©cessiter une prescription</li>
                        </ul>
                    </div>
                `;
            }

            if (analyse.etiquetage_standard) {
                resultHtml += `
                    <div class="alert alert-green">
                        <h4>üìù √âTIQUETAGE STANDARD √Ä APPLIQUER</h4>
                        <ul>
                            ${analyse.etiquetage_standard.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            resultContent.innerHTML = resultHtml;

            // Affichage des mod√®les d'√©tiquettes
            const labelPreview = document.getElementById('label-preview');
            const labelContent = document.getElementById('label-content');
            
            if (analyse.etiquette === 'n¬∞1' || analyse.etiquette === 'n¬∞2') {
                labelPreview.classList.remove('hidden');
                
                if (analyse.etiquette === 'n¬∞1') {
                    labelContent.innerHTML = `
                        <div class="label-sample label-danger">
                            ‚ò†Ô∏è POISON ‚ò†Ô∏è<br/>
                            <span style="font-size: 0.9rem;">√âtiquette n¬∞1 - T√™te de mort</span>
                            ${analyse.signe === 'ME' ? '<div style="font-size: 0.8rem; margin-top: 0.25rem;">PAS de conservation en armoire √† poisons</div>' : ''}
                        </div>
                    `;
                } else if (analyse.etiquette === 'n¬∞2') {
                    labelContent.innerHTML = `
                        <div class="label-sample label-warning">
                            ‚ö†Ô∏è Ne pas d√©passer la dose indiqu√©e ‚ö†Ô∏è<br/>
                            <span style="font-size: 0.9rem;">√âtiquette n¬∞2</span>
                        </div>
                    `;
                }
            } else {
                labelPreview.classList.add('hidden');
            }
        }

        // Reset du formulaire
        function resetForm() {
            document.getElementById('substance').value = '';
            document.getElementById('dose').value = '';
            document.getElementById('quantite').value = '';
            document.getElementById('unite').selectedIndex = 1;
            document.getElementById('forme').selectedIndex = 0;
            
            document.getElementById('placeholder').classList.remove('hidden');
            document.getElementById('reasoning').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            
            analyse = null;
            raisonnement = [];
        }

        // Gestion de la touche Entr√©e
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyserEtiquetage();
            }
        });
    </script>
</body>
</html>